
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¥èº«å€’è®¡æ—¶</title>
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563EB">
    <!-- è‹¹æœè®¾å¤‡æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://clockcn.com/favicon.ico">
    <link rel="icon" href="https://clockcn.com/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .hidden { display: none !important; }
      .launch-btn {
          padding: 8px 16px;
          font-size: 14px;
          background-color: #c20c0c;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          transition: background-color 0.3s;
          display: inline-flex;
          align-items: center;
          justify-content: center;
      }
      .launch-btn:hover {
          background-color: #9e0909;
      }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // ç½‘æ˜“äº‘éŸ³ä¹å¯åŠ¨åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('launchMusic')) {
                document.getElementById('launchMusic').addEventListener('click', function() {
                    // å°è¯•ä½¿ç”¨è‡ªå®šä¹‰åè®®å¯åŠ¨ç½‘æ˜“äº‘éŸ³ä¹
                    window.location.href = 'neteasemusic://';
                });
            }
        });
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        workout: '#059669',
                        rest: '#D97706',
                        dark: '#111827',
                        light: '#F3F4F6'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .timer-pulse { animation: none; }
        @keyframes pulse { 50% { transform: scale(1.08); } }
        
        .card-shadow { box-shadow: 0 12px 30px -8px rgba(0,0,0,0.1); }
        .status-badge { transition: all 0.3s ease; }
        /* æŒ‰é’®äº¤äº’åŠ¨ç”» */
        .btn-click { transition: all 0.15s ease; }
        .btn-click:active {
            transform: scale(0.95);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-bounce {
            animation: bounce 0.3s ease;
        }
        @keyframes bounce {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        /* æ¨¡å¼åˆ‡æ¢è¿‡æ¸¡åŠ¨ç”» - åŠ å¿«äº†é€Ÿåº¦ */
        .mode-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mode-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .mode-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        .mode-exit {
            opacity: 1;
        }
        .mode-exit-active {
            opacity: 0;
            transform: translateY(-20px);
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-light to-slate-100 min-h-screen p-4 text-dark">
    <!-- å›ºå®šé¡¶éƒ¨åŒºåŸŸ -->
    <div class="fixed top-0 left-0 right-0 z-10 bg-white/80 backdrop-blur-lg shadow-md py-4 px-6 transition-all duration-300">
        <div class="max-w-2xl mx-auto text-center">
            <h1 class="text-3xl font-extrabold text-primary mb-3">è®­ç»ƒåŠ©æ‰‹</h1>
            <p class="text-slate-600">å¾ªç¯è®­ç»ƒæ¨¡å¼ï¼ˆå…±4è½®ï¼‰</p>
            <!-- åŠŸèƒ½åˆ‡æ¢æ ‡ç­¾ -->
            <div class="flex justify-center mt-6 border-b border-slate-200 max-w-md mx-auto">
                <button id="workout-tab" class="px-6 py-2 font-medium text-primary border-b-2 border-primary">é”»ç‚¼æ¨¡å¼</button>
                <button id="timer-tab" class="px-6 py-2 font-medium text-slate-500 hover:text-slate-700">ç‹¬ç«‹è®¡æ—¶</button>
                <button id="plan-tab" class="px-6 py-2 font-medium text-slate-500 hover:text-slate-700">è®­ç»ƒè®¡åˆ’</button>
            </div>
            <button class="launch-btn mt-4" id="launchMusic">
                <i class="fa fa-music mr-2"></i>å¯åŠ¨ç½‘æ˜“äº‘éŸ³ä¹
            </button>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="max-w-2xl w-full mx-auto pt-64 pb-16">
        
        <!-- é”»ç‚¼æ¨¡å¼å®¹å™¨ - æ·»åŠ åŠ¨ç”»ç±» -->
        <div id="workout-mode" class="mode-container block mb-8">
        <div id="timer-card" class="bg-white/90 backdrop-blur-lg rounded-t-none rounded-3xl p-10 card-shadow -mt-2 relative z-0">
            <div class="flex flex-col gap-4 mb-6">
                <div class="text-center status-badge">
                    <span id="cycle-counter" class="px-5 py-2 rounded-full bg-primary/10 text-primary font-semibold text-lg">å¾ªç¯ 1/4</span>
                </div>
                <div class="text-center">
                    <h2 id="status-text" class="text-2xl font-bold text-workout">å‡†å¤‡å¼€å§‹è®­ç»ƒ</h2>
                </div>
            </div>
            <div class="text-center mb-10">
                <div id="display-area" class="text-5xl font-black text-workout timer-pulse" style="font-size: 3rem;">ç‚¹å‡»å¼€å§‹</div>
              </div>
            <div class="flex flex-col gap-3 max-w-sm mx-auto">
                <button id="start-btn" class="bg-primary hover:bg-primary/90 text-white py-4 rounded-full flex items-center justify-center gap-2 btn-click">
                    <i class="fa fa-play fa-lg"></i>
                    <span class="text-lg font-medium">å¼€å§‹è®­ç»ƒ</span>
                </button>
                <button id="reset-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 py-4 rounded-full flex items-center justify-center gap-2 btn-click">
                    <i class="fa fa-refresh fa-lg"></i>
                    <span class="text-lg font-medium">é‡ç½®è®­ç»ƒ</span>
                </button>
            </div>
            <div id="message" class="mt-6 text-center text-slate-600 text-base">æç¤ºï¼šå¯ä½¿ç”¨ç©ºæ ¼é”®æ§åˆ¶å¼€å§‹/å®Œæˆï¼ŒRé”®é‡ç½®</div>
        </div>
    </div>
    
    <!-- è®­ç»ƒè®¡åˆ’æ¨¡å¼å®¹å™¨ -->
    <div id="plan-mode" class="mode-container hidden mb-8 bg-white/90 backdrop-blur-lg rounded-3xl p-10 card-shadow max-w-md mx-auto w-full">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-primary mb-3">æ¯æ—¥è®­ç»ƒè®¡åˆ’</h2>
            <p class="text-slate-600">ç§‘å­¦å®‰æ’ä½ çš„è®­ç»ƒå†…å®¹</p>
        </div>
        <div class="overflow-y-auto max-h-[400px] pr-2">
            <div class="space-y-6" id="daily-plans">
                <!-- è®­ç»ƒè®¡åˆ’å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="mt-6 text-center text-sm text-slate-500">
            <p>æç¤ºï¼šç‚¹å‡»æ—¥æœŸæŸ¥çœ‹è¯¦ç»†è®­ç»ƒå†…å®¹</p>
        </div>
    </div>

    <!-- ç‹¬ç«‹è®¡æ—¶æ¨¡å¼å®¹å™¨ - æ·»åŠ åŠ¨ç”»ç±» -->
    <div id="timer-mode" class="mode-container hidden mb-8">
        <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-10 card-shadow max-w-md mx-auto w-full">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-primary mb-3">ç‹¬ç«‹è®¡æ—¶å™¨</h2>
                <p class="text-slate-600">è‡ªå®šä¹‰å€’è®¡æ—¶æ—¶é—´</p>
            </div>
            <div class="flex flex-col items-center gap-6 mb-8">
                <div class="w-full max-w-xs">
                    <label for="timer-input" class="block text-sm font-medium text-slate-700 mb-1">è®¾ç½®æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="timer-input" min="0" value="0" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-center text-xl" placeholder="è¾“å…¥ç§’æ•°">
                <div class="flex gap-4 w-full max-w-xs mt-4">
                    <div class="flex-1">
                        <label for="timer-minutes" class="block text-left text-slate-600 mb-2">åˆ†</label>
                        <input
                            type="number" id="timer-minutes" min="0" value="0" step="1"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        >
                    </div>
                    <div class="flex-1">
                        <label for="timer-seconds" class="block text-left text-slate-600 mb-2">ç§’</label>
                        <input
                            type="number" id="timer-seconds" min="0" max="59" value="0"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        >
                    </div>
                </div>
                </div>
                <div id="timer-display" class="text-7xl font-black text-primary timer-pulse">00:00</div>
                <div id="timer-message" class="text-center text-slate-600 mt-2"></div>
            </div>
            <div class="flex flex-col gap-3 max-w-sm mx-auto">
                <button id="timer-start-btn" class="bg-primary hover:bg-primary/90 text-white py-4 rounded-full flex items-center justify-center gap-2 btn-click">
                    <i class="fa fa-play fa-lg"></i>
                    <span class="text-lg font-medium">å¼€å§‹è®¡æ—¶</span>
                </button>
                <button id="timer-reset-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 py-4 rounded-full flex items-center justify-center gap-2 btn-click">
                    <i class="fa fa-refresh fa-lg"></i>
                    <span class="text-lg font-medium">é‡ç½®è®¡æ—¶</span>
                </button>
            </div>
           
        </div>
    </div>
    <script>
        const appState = {
            totalCycles: 4,
            currentCycle: 1,
            isRunning: false,
            isResting: false,
            timer: null,
            audioInstance: null,
            clickSound: new Audio('down_fail.mp3'),
            seconds: 60,

            currentExerciseIndex: 0,
            currentPlan: null,
            exercises: []
        };

        const dom = {
            startBtn: document.getElementById('start-btn'),
            resetBtn: document.getElementById('reset-btn'),
            displayArea: document.getElementById('display-area'),
            statusText: document.getElementById('status-text'),
            cycleCounter: document.getElementById('cycle-counter'),
            message: document.getElementById('message'),
            timerCard: document.getElementById('timer-card')
        };

        function updateDisplay() {
            if (appState.isResting) {
                const mins = Math.floor(appState.seconds / 60);
                const secs = appState.seconds % 60;
                dom.displayArea.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                document.title = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')} - å¥èº«å€’è®¡æ—¶`;
            } else {
                dom.displayArea.textContent = 'é”»ç‚¼ä¸­';
                document.title = `é”»ç‚¼ä¸­ - æ™ºèƒ½å¥èº«å€’è®¡æ—¶`;
            }
        }

        function updateCycleCounter() {
            dom.cycleCounter.textContent = `å¾ªç¯ ${appState.currentCycle}/${appState.totalCycles}`;
            dom.cycleCounter.classList.toggle('bg-primary/10', !appState.isResting);
            dom.cycleCounter.classList.toggle('bg-rest/10', appState.isResting);
        }

        function getCurrentDay() {
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const today = new Date();
            return days[today.getDay()];
        }

        function getTodayPlan() {
            const today = getCurrentDay();
            if (today === 'å‘¨æ—¥') {
                return { isRestDay: true };
            }
            return trainingPlans.find(plan => plan.days && plan.days.includes(today)) || { isNoPlan: true };
        }

        function updateWorkoutModeHeader() {
            const today = getCurrentDay();
            const todayPlan = getTodayPlan();
            
            if (today === 'å‘¨æ—¥') {
                dom.statusText.textContent = 'ä»Šå¤©æ˜¯æ”¾çºµæ—¥ï¼';
                dom.statusText.classList = 'text-2xl font-bold text-primary';
                dom.displayArea.textContent = 'å¥½å¥½ä¼‘æ¯';
                dom.startBtn.disabled = true;
                dom.message.textContent = 'ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥ï¼Œå¥½å¥½æ”¾æ¾å§ï¼';
            } else if (todayPlan.isNoPlan) {
                dom.statusText.textContent = 'ä»Šå¤©æ²¡æœ‰è®­ç»ƒè®¡åˆ’';
                dom.statusText.classList = 'text-2xl font-bold text-slate-500';
                dom.displayArea.textContent = 'æ— è®¡åˆ’';
                dom.startBtn.disabled = true;
                dom.message.textContent = 'è¯·å…ˆåœ¨è®­ç»ƒè®¡åˆ’ä¸­æ·»åŠ ä»Šå¤©çš„è®­ç»ƒå†…å®¹';
            } else {
                dom.statusText.textContent = `${today} - ${todayPlan.title}`;
                dom.statusText.classList = 'text-2xl font-bold text-primary';
                dom.displayArea.textContent = 'ç‚¹å‡»å¼€å§‹';
                dom.startBtn.disabled = false;
                dom.message.textContent = 'æç¤ºï¼šå¯ä½¿ç”¨ç©ºæ ¼é”®æ§åˆ¶å¼€å§‹/å®Œæˆï¼ŒRé”®é‡ç½®';
            }
        }

        function startWorkout() {
            const todayPlan = getTodayPlan();
            if (todayPlan.isRestDay || todayPlan.isNoPlan) return;

            appState.isRunning = true;
            appState.isResting = false;
            // ä»…åœ¨é¦–æ¬¡å¼€å§‹è®­ç»ƒæ—¶è®¾ç½®currentPlanå’Œexercises
            if (!appState.currentPlan) {
                appState.currentPlan = todayPlan;
                appState.exercises = todayPlan.exercises;
                appState.currentExerciseIndex = 0;
            }
            // å¦‚æœæ˜¯ç»§ç»­è®­ç»ƒï¼Œåˆ™ä¿æŒcurrentExerciseIndexä¸å˜

            updateExerciseDisplay();
            dom.timerCard.classList = 'bg-white/90 backdrop-blur-lg rounded-3xl p-10 card-shadow border-2 border-workout/20';
            dom.message.textContent = 'ä¸“æ³¨é”»ç‚¼ï¼Œå®Œæˆåç‚¹å‡»æŒ‰é’®è¿›å…¥ä¼‘æ¯';
            dom.startBtn.innerHTML = '<i class="fa fa-flag-checkered fa-lg"></i><span class="text-lg font-medium">å®Œæˆé”»ç‚¼</span>';
            updateCycleCounter();

            if (appState.timer) clearInterval(appState.timer);
        }

        function updateExerciseDisplay() {
            if (!appState.currentPlan || appState.exercises.length === 0) return;

            const currentExercise = appState.exercises[appState.currentExerciseIndex];
            dom.statusText.textContent = `${getCurrentDay()} - ${appState.currentPlan.title} - ${currentExercise.name}`;
            dom.statusText.classList = 'text-2xl font-bold text-workout';
            dom.displayArea.textContent = 'é”»ç‚¼ä¸­';
            dom.displayArea.classList = 'text-7xl font-black text-workout timer-pulse';
        }

        function switchToRest() {
            appState.isRunning = false;
            appState.isResting = true;
            appState.seconds = appState.currentCycle === 4 ? 90 : 60;
            dom.statusText.textContent = 'ä¼‘æ¯æ¢å¤ä¸­';
            dom.statusText.classList = 'text-2xl font-bold text-rest';
            dom.displayArea.classList = 'text-7xl font-black text-rest timer-pulse';
            dom.timerCard.classList = 'bg-white/90 backdrop-blur-lg rounded-3xl p-10 card-shadow border-2 border-rest/20';
            dom.message.textContent = appState.currentCycle === 4 ? 'å½“å‰å·¥ä½œå·²å®Œæˆï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ªåŠ¨ä½œ' : 'é€‚å½“ä¼‘æ¯ï¼Œå‡†å¤‡ä¸‹ä¸€è½®è®­ç»ƒ';
            dom.startBtn.innerHTML = '<i class="fa fa-clock-o fa-lg"></i><span class="text-lg font-medium">ä¼‘æ¯è®¡æ—¶ä¸­</span>';
            dom.startBtn.disabled = true;

            appState.timer = setInterval(() => {
                if (appState.seconds <= 0) {
                    clearInterval(appState.timer);
                    // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
                    if (appState.audioInstance) {
                        appState.audioInstance.pause();
                        appState.audioInstance = null;
                    }
                    // åˆ›å»ºæ–°çš„éŸ³é¢‘å®ä¾‹å¹¶æ’­æ”¾
                    appState.audioInstance = new Audio('https://clockcn.com/sound/xylophone.mp3');
                    appState.audioInstance.loop = true;
                    appState.audioInstance.play();
                    handleCycleCompletion();
                    return;
                }
                appState.seconds--;
                updateDisplay();
            }, 1000);
        }

        function handleCycleCompletion() {
            if (appState.currentCycle < appState.totalCycles) {
                appState.currentCycle++;
                dom.statusText.textContent = 'ä¼‘æ¯ç»“æŸ';
                dom.displayArea.textContent = 'ç‚¹å‡»å¼€å§‹';
                dom.displayArea.classList = 'text-7xl font-black text-workout';
                dom.message.textContent = 'å·²å®Œæˆå½“å‰è½®æ¬¡ï¼Œç‚¹å‡»å¼€å§‹ä¸‹ä¸€è½®è®­ç»ƒ';
                dom.startBtn.innerHTML = '<i class="fa fa-play fa-lg"></i><span class="text-lg font-medium">å¼€å§‹ä¸‹ä¸€è½®</span>';
                dom.startBtn.disabled = false;
                appState.isRunning = false;
                appState.isResting = false;
            } else {
                completeAllCycles();
            }
        }

        function completeAllCycles() {
            clearInterval(appState.timer);
            appState.isRunning = false;
            appState.isResting = false;
            appState.currentCycle = 1;
            updateCycleCounter();

            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªåŠ¨ä½œ
            if (appState.currentExerciseIndex < appState.exercises.length - 1) {
                appState.currentExerciseIndex++;
                dom.statusText.textContent = `å‡†å¤‡ä¸‹ä¸€ä¸ªåŠ¨ä½œ: ${appState.exercises[appState.currentExerciseIndex].name}`;
                dom.statusText.classList = 'text-2xl font-bold text-primary';
                dom.displayArea.textContent = 'ç‚¹å‡»å¼€å§‹';
                dom.displayArea.classList = 'text-7xl font-black text-workout';
                dom.timerCard.classList = 'bg-white/90 backdrop-blur-lg rounded-3xl p-10 card-shadow border-2 border-primary/20';
                dom.message.textContent = 'å‡†å¤‡å¥½åï¼Œç‚¹å‡»å¼€å§‹æŒ‰é’®ç»§ç»­è®­ç»ƒ';
                dom.startBtn.innerHTML = '<i class="fa fa-play fa-lg"></i><span class="text-lg font-medium">å¼€å§‹ä¸‹ä¸€ä¸ª</span>';
                dom.startBtn.disabled = false;
            } else {
                // æ‰€æœ‰åŠ¨ä½œéƒ½å·²å®Œæˆ
                dom.statusText.textContent = 'ä»Šå¤©è®­ç»ƒå®Œæˆï¼';
                dom.statusText.classList = 'text-2xl font-bold text-primary';
                dom.displayArea.textContent = 'ğŸ‰';
                dom.displayArea.classList = 'text-7xl font-black text-primary';
                dom.timerCard.classList = 'bg-white/90 backdrop-blur-lg rounded-3xl p-10 card-shadow border-2 border-primary/20';
                dom.message.textContent = 'æ­å–œä½ å®Œæˆäº†ä»Šå¤©çš„æ‰€æœ‰è®­ç»ƒï¼';
                dom.startBtn.innerHTML = '<i class="fa fa-refresh fa-lg"></i><span class="text-lg font-medium">é‡æ–°å¼€å§‹</span>';
                dom.startBtn.disabled = false;
            }
        }

        function resetApp() {
            clearInterval(appState.timer);
            if (appState.audioInstance) {
                appState.audioInstance.pause();
                appState.audioInstance = null;
            }
            appState.currentCycle = 1;
            appState.isRunning = false;
            appState.isResting = false;
            appState.seconds = 60;
            dom.displayArea.textContent = 'ç‚¹å‡»å¼€å§‹';
            dom.displayArea.classList = 'text-7xl font-black text-workout';
            dom.statusText.textContent = 'å‡†å¤‡å¼€å§‹è®­ç»ƒ';
            dom.statusText.classList = 'text-2xl font-bold text-workout';
            dom.timerCard.classList = 'bg-white/90 backdrop-blur-lg rounded-3xl p-10 card-shadow';
            dom.startBtn.innerHTML = '<i class="fa fa-play fa-lg"></i><span class="text-lg font-medium">å¼€å§‹è®­ç»ƒ</span>';
            dom.startBtn.disabled = false;
            dom.message.textContent = 'æç¤ºï¼šå¯ä½¿ç”¨ç©ºæ ¼é”®æ§åˆ¶å¼€å§‹/å®Œæˆï¼ŒRé”®é‡ç½®';
            updateCycleCounter();
        }

        dom.startBtn.addEventListener('click', () => {
            appState.clickSound.currentTime = 0;
            appState.clickSound.play();
            
            dom.startBtn.classList.add('btn-bounce');
            setTimeout(() => {
                dom.startBtn.classList.remove('btn-bounce');
            }, 300);
            
            if (!appState.isRunning && !appState.isResting) {
                if (appState.audioInstance) {
                    appState.audioInstance.pause();
                    appState.audioInstance = null;
                }
                startWorkout();
            } else if (appState.isRunning && !appState.isResting) {
                clearInterval(appState.timer);
                switchToRest();
            }
        });

        dom.resetBtn.addEventListener('click', () => {
            appState.clickSound.currentTime = 0;
            appState.clickSound.play();
            
            dom.resetBtn.classList.add('btn-bounce');
            setTimeout(() => {
                dom.resetBtn.classList.remove('btn-bounce');
            }, 300);
            
            resetApp();
        });

        // ç‹¬ç«‹è®¡æ—¶å™¨çŠ¶æ€
        const timerState = {
            isRunning: false,
            minutes: 0,
            seconds: 0,
            timer: null,
            endSound: null
        };

        // åˆå§‹åŒ–å€’è®¡æ—¶æç¤ºéŸ³
        function initTimerAudio() {
            if (!timerState.endSound) {
                timerState.endSound = new Audio('https://clockcn.com/sound/xylophone.mp3');
                timerState.endSound.loop = true;
                timerState.endSound.addEventListener('error', function() {
                    console.error('æ— æ³•åŠ è½½å€’è®¡æ—¶ç»“æŸå£°éŸ³');
                    timerDom.timerMessage.textContent = 'æç¤ºï¼šæ— æ³•åŠ è½½å€’è®¡æ—¶ç»“æŸå£°éŸ³';
                });
            }
        }

        // å£°æ˜å…¨å±€å˜é‡
        let timerDom = null;
        let updateTimerDisplay = null;
        let startTimer = null;
        let resetTimer = null;
        let switchMode = null;
        let trainingPlans = [];

        // ç¡®ä¿DOMåŠ è½½å®Œæˆåå†è·å–å…ƒç´ 
        document.addEventListener('DOMContentLoaded', function() {
            // ä»localStorageåŠ è½½è®­ç»ƒè®¡åˆ’æ•°æ®
            trainingPlans = JSON.parse(localStorage.getItem('trainingPlans')) || [
                {
                    id: 'plan1',
                    date: '2023-10-23',
                    day: 'å‘¨ä¸€',
                    title: 'ä¸Šè‚¢åŠ›é‡è®­ç»ƒ',
                    exercises: [
                        { id: 'ex1-1', name: 'ä¿¯å§æ’‘', sets: 4, reps: '12-15', rest: '60ç§’' },
                        { id: 'ex1-2', name: 'å¼•ä½“å‘ä¸Š', sets: 3, reps: '8-10', rest: '90ç§’' },
                        { id: 'ex1-3', name: 'å“‘é“ƒå¼¯ä¸¾', sets: 3, reps: '10-12', rest: '60ç§’' },
                        { id: 'ex1-4', name: 'ä¸‰å¤´è‚Œè‡‚å±ˆä¼¸', sets: 3, reps: '12-15', rest: '60ç§’' }
                    ]
                },
                {
                    id: 'plan2',
                    date: '2023-10-24',
                    day: 'å‘¨äºŒ',
                    title: 'ä¸‹è‚¢åŠ›é‡è®­ç»ƒ',
                    exercises: [
                        { id: 'ex2-1', name: 'æ·±è¹²', sets: 4, reps: '10-12', rest: '90ç§’' },
                        { id: 'ex2-2', name: 'ç®­æ­¥è¹²', sets: 3, reps: '10-12/è…¿', rest: '60ç§’' },
                        { id: 'ex2-3', name: 'ç¡¬æ‹‰', sets: 3, reps: '8-10', rest: '120ç§’' },
                        { id: 'ex2-4', name: 'æè¸µ', sets: 4, reps: '15-20', rest: '45ç§’' }
                    ]
                },
                {
                    id: 'plan3',
                    date: '2023-10-25',
                    day: 'å‘¨ä¸‰',
                    title: 'æ ¸å¿ƒè®­ç»ƒ',
                    exercises: [
                        { id: 'ex3-1', name: 'å¹³æ¿æ”¯æ’‘', sets: 3, reps: '60ç§’', rest: '45ç§’' },
                        { id: 'ex3-2', name: 'ä»°å§èµ·å', sets: 3, reps: '15-20', rest: '45ç§’' },
                        { id: 'ex3-3', name: 'ä¿„ç½—æ–¯è½¬ä½“', sets: 3, reps: '20/ä¾§', rest: '45ç§’' },
                        { id: 'ex3-4', name: 'æ‚¬æŒ‚ä¸¾è…¿', sets: 3, reps: '10-12', rest: '60ç§’' }
                    ]
                },
                {
                    id: 'plan4',
                    date: '2023-10-26',
                    day: 'å‘¨å››',
                    title: 'æœ‰æ°§è®­ç»ƒ',
                    exercises: [
                        { id: 'ex4-1', name: 'æ…¢è·‘', sets: 1, reps: '30åˆ†é’Ÿ', rest: '0ç§’' },
                        { id: 'ex4-2', name: 'è·³ç»³', sets: 5, reps: '1åˆ†é’Ÿ', rest: '30ç§’' },
                        { id: 'ex4-3', name: 'é«˜æŠ¬è…¿', sets: 3, reps: '30ç§’', rest: '30ç§’' }
                    ]
                },
                {
                    id: 'plan5',
                    date: '2023-10-27',
                    day: 'å‘¨äº”',
                    title: 'å…¨èº«è®­ç»ƒ',
                    exercises: [
                        { id: 'ex5-1', name: 'æ³¢æ¯”è·³', sets: 3, reps: '10-12', rest: '60ç§’' },
                        { id: 'ex5-2', name: 'ç®±å¼è·³è·ƒ', sets: 3, reps: '8-10', rest: '60ç§’' },
                        { id: 'ex5-3', name: 'ç™»å±±è€…', sets: 3, reps: '30ç§’', rest: '30ç§’' },
                        { id: 'ex5-4', name: 'å£¶é“ƒæ‘†åŠ¨', sets: 3, reps: '15-20', rest: '60ç§’' }
                    ]
                }
            ];

            // é‡ç½®æ‰€æœ‰completedçŠ¶æ€ä¸ºfalse
            trainingPlans.forEach(plan => {
                plan.exercises.forEach(exercise => {
                    exercise.completed = false;
                });
            });
            // ä¿å­˜é‡ç½®åçš„è®­ç»ƒè®¡åˆ’
            saveTrainingPlans();

            // ä¿å­˜è®­ç»ƒè®¡åˆ’åˆ°localStorage
            function saveTrainingPlans() {
                localStorage.setItem('trainingPlans', JSON.stringify(trainingPlans));
            }

            // æ·»åŠ æ–°è®­ç»ƒè®¡åˆ’
            function addTrainingPlan(newPlan) {
                const planWithId = {...newPlan, id: 'plan' + Date.now()};
                trainingPlans.push(planWithId);
                saveTrainingPlans();
                renderTrainingPlans();
            }

            // æ›´æ–°è®­ç»ƒè®¡åˆ’
            function updateTrainingPlan(planId, updatedPlan) {
                const index = trainingPlans.findIndex(plan => plan.id === planId);
                if (index !== -1) {
                    trainingPlans[index] = {...trainingPlans[index], ...updatedPlan};
                    saveTrainingPlans();
                    renderTrainingPlans();
                }
            }

            // åˆ é™¤è®­ç»ƒè®¡åˆ’
            function deleteTrainingPlan(planId) {
                trainingPlans = trainingPlans.filter(plan => plan.id !== planId);
                saveTrainingPlans();
                renderTrainingPlans();
            }

            // åˆ é™¤æ‰€æœ‰è®­ç»ƒè®¡åˆ’
            function deleteAllTrainingPlans() {
                if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è®­ç»ƒè®¡åˆ’å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    trainingPlans = [];
                    saveTrainingPlans();
                    renderTrainingPlans();
                }
            }

            // æ¸²æŸ“è®­ç»ƒè®¡åˆ’
            function renderTrainingPlans() {
                const planContainer = document.getElementById('daily-plans');
                if (!planContainer) return;

                planContainer.innerHTML = '';

                // æ·»åŠ æ“ä½œæŒ‰é’®å®¹å™¨
                const actionButtonsContainer = document.createElement('div');
                actionButtonsContainer.className = 'flex flex-col items-center justify-center gap-4 mb-4';

                // æ·»åŠ æ–°å»ºè®¡åˆ’æŒ‰é’®
                const addButton = document.createElement('div');
                addButton.className = 'bg-primary/10 hover:bg-primary/20 rounded-xl p-5 text-center cursor-pointer transition-colors';
                addButton.innerHTML = `
                    <i class="fa fa-plus-circle text-primary text-3xl mb-2"></i>
                    <div class="text-primary font-medium">æ·»åŠ æ–°è®­ç»ƒè®¡åˆ’</div>
                `;
                addButton.addEventListener('click', () => openPlanEditor());
                actionButtonsContainer.appendChild(addButton);

                // æ·»åŠ åˆ é™¤æ‰€æœ‰è®¡åˆ’æŒ‰é’®
                const deleteAllButton = document.createElement('button');
                deleteAllButton.className = 'bg-red-50 hover:bg-red-100 rounded-full p-3 text-center cursor-pointer transition-colors';
                deleteAllButton.title = 'åˆ é™¤æ‰€æœ‰è®¡åˆ’';
                deleteAllButton.innerHTML = `
                    <i class="fa fa-trash text-red-500 text-xl"></i>
                `;
                deleteAllButton.addEventListener('click', () => deleteAllTrainingPlans());
                actionButtonsContainer.appendChild(deleteAllButton);

                planContainer.appendChild(actionButtonsContainer);

                trainingPlans.forEach(plan => {
                    const planCard = document.createElement('div');
                    planCard.className = 'bg-slate-50 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow cursor-pointer plan-card mb-4';
                    // ç§»é™¤ä¸å†ä½¿ç”¨çš„dateå±æ€§
                    planCard.setAttribute('data-id', plan.id);

                    planCard.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-primary">${plan.title}</h3>
                            <div class="flex space-x-2">
                                <button class="edit-plan-btn text-slate-500 hover:text-primary p-1" data-id="${plan.id}">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="delete-plan-btn text-slate-500 hover:text-red-500 p-1" data-id="${plan.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-slate-500 text-sm mb-4">æ˜ŸæœŸ: ${plan.days ? plan.days.join('ã€') : 'æœªé€‰æ‹©'}</div>
                        <div class="plan-details hidden mt-3 space-y-2">
                            <h4 class="font-semibold text-slate-700 mb-2">è®­ç»ƒå†…å®¹:</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                    <thead class="bg-primary/5">
                                        <tr>
                                            <th class="py-2 px-3 text-left text-sm font-medium text-slate-600">å®Œæˆ</th>
                                            <th class="py-2 px-3 text-left text-sm font-medium text-slate-600">åŠ¨ä½œ</th>
                                            <th class="py-2 px-3 text-left text-sm font-medium text-slate-600">ç»„æ•°</th>
                                            <th class="py-2 px-3 text-left text-sm font-medium text-slate-600">æ¬¡æ•°</th>
                                            <th class="py-2 px-3 text-left text-sm font-medium text-slate-600">ä¼‘æ¯</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${plan.exercises.map(ex => `
                                            <tr data-exercise-id="${ex.id || Math.random().toString(36).substr(2, 9)}">
                                                <td class="py-2 px-3 text-sm text-slate-700">
                                                    <input type="checkbox" class="exercise-checkbox rounded border-slate-300 text-primary focus:ring-primary" ${ex.completed ? 'checked' : ''}>
                                                </td>
                                                <td class="py-2 px-3 text-sm text-slate-700 ${ex.completed ? 'line-through text-slate-400' : ''}">${ex.name}</td>
                                                <td class="py-2 px-3 text-sm text-slate-700">${ex.sets}</td>
                                                <td class="py-2 px-3 text-sm text-slate-700">${ex.reps}</td>
                                                <td class="py-2 px-3 text-sm text-slate-700">${ex.rest}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    // ä¸ºé”»ç‚¼é¡¹ç›®å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
                    setTimeout(() => {
                        const checkboxes = planCard.querySelectorAll('.exercise-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', (e) => {
                                const exerciseId = e.target.closest('tr').dataset.exerciseId;
                                const exercise = plan.exercises.find(ex => ex.id === exerciseId || !ex.id);
                                if (exercise) {
                                    exercise.completed = e.target.checked;
                                    // å¦‚æœæ²¡æœ‰idï¼Œä¸ºåç»­ä¿å­˜åˆ›å»ºä¸€ä¸ªid
                                    if (!exercise.id) {
                                        exercise.id = exerciseId;
                                    }
                                    saveTrainingPlans();
                                    // æ›´æ–°UI
                                    const nameCell = e.target.closest('tr').querySelector('td:nth-child(2)');
                                    if (e.target.checked) {
                                        nameCell.classList.add('line-through', 'text-slate-400');
                                    } else {
                                        nameCell.classList.remove('line-through', 'text-slate-400');
                                    }
                                }
                            });
                        });
                    }, 0);

                    // å±•å¼€/æ”¶èµ·è¯¦æƒ…
                    planCard.addEventListener('click', (event) => {
                        if (!event.target.closest('.edit-plan-btn') && !event.target.closest('.delete-plan-btn') && !event.target.closest('.exercise-checkbox')) {
                            event.stopPropagation();
                            const details = planCard.querySelector('.plan-details');
                            details.classList.toggle('hidden');
                        }
                    });

                    // ç¼–è¾‘è®¡åˆ’
                    planCard.querySelector('.edit-plan-btn').addEventListener('click', (event) => {
                        event.stopPropagation();
                        openPlanEditor(plan.id);
                    });

                    // åˆ é™¤è®¡åˆ’
                    planCard.querySelector('.delete-plan-btn').addEventListener('click', (event) => {
                        event.stopPropagation();
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®­ç»ƒè®¡åˆ’å—ï¼Ÿ')) {
                            deleteTrainingPlan(plan.id);
                        }
                    });

                    planContainer.appendChild(planCard);
                });
            }

            // æ‰“å¼€è®¡åˆ’ç¼–è¾‘å™¨
            function openPlanEditor(planId = null) {
                // åˆ›å»ºæ¨¡æ€æ¡†èƒŒæ™¯
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';

                // æŸ¥æ‰¾è¦ç¼–è¾‘çš„è®¡åˆ’
                const planToEdit = planId ? trainingPlans.find(plan => plan.id === planId) : null;

                // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto';
                modalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-primary">${planId ? 'ç¼–è¾‘è®­ç»ƒè®¡åˆ’' : 'æ·»åŠ æ–°è®­ç»ƒè®¡åˆ’'}</h3>
                        <button class="close-modal text-slate-500 hover:text-slate-700 p-2" title="å…³é—­çª—å£"><i class="fa fa-times text-xl"></i></button>
                    </div>
                    <form id="plan-editor-form" class="space-y-4">
                        ${planId ? `<input type="hidden" name="planId" value="${planId}">` : ''}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="plan-title" class="block text-sm font-medium text-slate-700 mb-1">è®¡åˆ’æ ‡é¢˜</label>
                                <input type="text" id="plan-title" name="title" required
                                    value="${planToEdit ? planToEdit.title : ''}"
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary">
                            </div>
                            <!-- å·²ç§»é™¤æ—¥æœŸè¾“å…¥æ¡† -->
                        </div>
                        <div>
                            <label for="plan-day" class="block text-sm font-medium text-slate-700 mb-1">æ˜ŸæœŸå‡  (æŒ‰ä½Ctrlé”®å¯å¤šé€‰)</label>
                            <select id="plan-day" name="day" required multiple
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary h-32">
                                <option value="å‘¨ä¸€" ${planToEdit && planToEdit.days && planToEdit.days.includes('å‘¨ä¸€') ? 'selected' : ''}>å‘¨ä¸€</option>
                                <option value="å‘¨äºŒ" ${planToEdit && planToEdit.days && planToEdit.days.includes('å‘¨äºŒ') ? 'selected' : ''}>å‘¨äºŒ</option>
                                <option value="å‘¨ä¸‰" ${planToEdit && planToEdit.days && planToEdit.days.includes('å‘¨ä¸‰') ? 'selected' : ''}>å‘¨ä¸‰</option>
                                <option value="å‘¨å››" ${planToEdit && planToEdit.days && planToEdit.days.includes('å‘¨å››') ? 'selected' : ''}>å‘¨å››</option>
                                <option value="å‘¨äº”" ${planToEdit && planToEdit.days && planToEdit.days.includes('å‘¨äº”') ? 'selected' : ''}>å‘¨äº”</option>
                                <option value="å‘¨å…­" ${planToEdit && planToEdit.days && planToEdit.days.includes('å‘¨å…­') ? 'selected' : ''}>å‘¨å…­</option>
                                <option value="å‘¨æ—¥" ${planToEdit && planToEdit.days && planToEdit.days.includes('å‘¨æ—¥') ? 'selected' : ''}>å‘¨æ—¥</option>
                            </select>
                        </div>
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">è®­ç»ƒåŠ¨ä½œ</h4>
                            <div id="exercises-container" class="space-y-3">
                                ${planToEdit ? planToEdit.exercises.map((ex, index) => `
                                    <div class="exercise-item grid grid-cols-1 md:grid-cols-4 gap-3 p-3 border border-slate-200 rounded-lg">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">åŠ¨ä½œåç§°</label>
                                            <input type="text" name="exercise-name-${index}" required value="${ex.name}"
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">ç»„æ•°</label>
                                            <input type="number" name="exercise-sets-${index}" required value="${ex.sets}" min="1"
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">æ¬¡æ•°</label>
                                            <input type="text" name="exercise-reps-${index}" required value="${ex.reps}"
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">ä¼‘æ¯æ—¶é—´</label>
                                            <input type="text" name="exercise-rest-${index}" required value="${ex.rest}"
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                        <button type="button" class="remove-exercise md:col-start-4 text-red-500 hover:text-red-700 text-sm mt-1 self-end"
                                            data-index="${index}"><i class="fa fa-minus-circle"></i> åˆ é™¤</button>
                                    </div>
                                `).join('') : `
                                    <div class="exercise-item grid grid-cols-1 md:grid-cols-4 gap-3 p-3 border border-slate-200 rounded-lg">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">åŠ¨ä½œåç§°</label>
                                            <input type="text" name="exercise-name-0" required
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">ç»„æ•°</label>
                                            <input type="number" name="exercise-sets-0" required value="3" min="1"
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">æ¬¡æ•°</label>
                                            <input type="text" name="exercise-reps-0" required value="10-12"
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">ä¼‘æ¯æ—¶é—´</label>
                                            <input type="text" name="exercise-rest-0" required value="60ç§’"
                                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                                        </div>
                                    </div>
                                `}
                            </div>
                            <button type="button" id="add-exercise-btn" class="mt-2 text-primary hover:text-primary/80 text-sm flex items-center">
                                <i class="fa fa-plus-circle mr-1"></i> æ·»åŠ åŠ¨ä½œ
                            </button>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4 border-t border-slate-200">
                            <button type="button" class="cancel-btn px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">å–æ¶ˆ</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 focus:ring-2 focus:ring-primary focus:ring-offset-2">ä¿å­˜è®¡åˆ’</button>
                        </div>
                    </form>
                `;

                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);

                // å…³é—­æ¨¡æ€æ¡†
                modalContent.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(modalOverlay);
                });
                modalContent.querySelector('.cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modalOverlay);
                });
                // ç§»é™¤ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
                // modalOverlay.addEventListener('click', (event) => {
                //     if (event.target === modalOverlay) {
                //         document.body.removeChild(modalOverlay);
                //     }
                // });

                // æ·»åŠ æ–°åŠ¨ä½œ
                let exerciseCount = planToEdit ? planToEdit.exercises.length : 1;
                modalContent.querySelector('#add-exercise-btn').addEventListener('click', () => {
                    const container = modalContent.querySelector('#exercises-container');
                    const newExercise = document.createElement('div');
                    newExercise.className = 'exercise-item grid grid-cols-1 md:grid-cols-4 gap-3 p-3 border border-slate-200 rounded-lg';
                    newExercise.innerHTML = `
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">åŠ¨ä½œåç§°</label>
                            <input type="text" name="exercise-name-${exerciseCount}" required
                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">ç»„æ•°</label>
                            <input type="number" name="exercise-sets-${exerciseCount}" required value="3" min="1"
                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">æ¬¡æ•°</label>
                            <input type="text" name="exercise-reps-${exerciseCount}" required value="10-12"
                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">ä¼‘æ¯æ—¶é—´</label>
                            <input type="text" name="exercise-rest-${exerciseCount}" required value="60ç§’"
                                class="w-full px-2 py-1.5 border border-slate-300 rounded focus:ring-primary focus:border-primary text-sm">
                        </div>
                        <button type="button" class="remove-exercise md:col-start-4 text-red-500 hover:text-red-700 text-sm mt-1 self-end"
                            data-index="${exerciseCount}"><i class="fa fa-minus-circle"></i> åˆ é™¤</button>
                    `;
                    container.appendChild(newExercise);
                    exerciseCount++;

                    // ä¸ºæ–°æ·»åŠ çš„åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
                    newExercise.querySelector('.remove-exercise').addEventListener('click', (event) => {
                        const index = parseInt(event.currentTarget.dataset.index);
                        container.removeChild(newExercise);
                    });
                });

                // åˆ é™¤åŠ¨ä½œ
                modalContent.querySelectorAll('.remove-exercise').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = parseInt(event.currentTarget.dataset.index);
                        const item = event.currentTarget.closest('.exercise-item');
                        modalContent.querySelector('#exercises-container').removeChild(item);
                    });
                });

                // è¡¨å•æäº¤
                modalContent.querySelector('#plan-editor-form').addEventListener('submit', (event) => {
                    event.preventDefault();
                    const formData = new FormData(event.target);
                    const planId = formData.get('planId');
                    const title = formData.get('title');
                    const date = formData.get('date');
                    // è·å–æ‰€æœ‰é€‰ä¸­çš„æ˜ŸæœŸå€¼
                    const days = Array.from(document.getElementById('plan-day').selectedOptions).map(option => option.value);
                    const exercises = [];

                    // æ”¶é›†æ‰€æœ‰åŠ¨ä½œ
                    let i = 0;
                    while (formData.has(`exercise-name-${i}`)) {
                        exercises.push({
                            id: 'ex' + Date.now() + '-' + i,
                            name: formData.get(`exercise-name-${i}`),
                            sets: parseInt(formData.get(`exercise-sets-${i}`)),
                            reps: formData.get(`exercise-reps-${i}`),
                            rest: formData.get(`exercise-rest-${i}`)
                        });
                        i++;
                    }

                    if (planId) {
                        // æ›´æ–°ç°æœ‰è®¡åˆ’
                        updateTrainingPlan(planId, {
                            title,
                            date,
                            days,
                            exercises
                        });
                    } else {
                        // æ·»åŠ æ–°è®¡åˆ’
                        addTrainingPlan({
                            title,
                            days,
                            exercises
                        });
                    }

                    document.body.removeChild(modalOverlay);
                });
            }

        // ç‹¬ç«‹è®¡æ—¶å™¨DOMå…ƒç´ 
            timerDom = {
                workoutTab: document.getElementById('workout-tab'),
                timerTab: document.getElementById('timer-tab'),
                planTab: document.getElementById('plan-tab'),
                workoutMode: document.getElementById('workout-mode'),
                timerMode: document.getElementById('timer-mode'),
                planMode: document.getElementById('plan-mode'),
                timerMinutes: document.getElementById('timer-minutes'),
                timerSeconds: document.getElementById('timer-seconds'),
                timerDisplay: document.getElementById('timer-display'),
                timerStartBtn: document.getElementById('timer-start-btn'),
                timerResetBtn: document.getElementById('timer-reset-btn'),
                timerMessage: document.getElementById('timer-message'),
                timerInput: document.getElementById('timer-input')
            };

            // æ›´æ–°ç‹¬ç«‹è®¡æ—¶å™¨æ˜¾ç¤º
            updateTimerDisplay = function() {
                if (timerDom && timerDom.timerDisplay) {
                    timerDom.timerDisplay.textContent = `${timerState.minutes.toString().padStart(2, '0')}:${timerState.seconds.toString().padStart(2, '0')}`;
                    timerDom.timerDisplay.classList.toggle('final-countdown', timerState.minutes === 0 && timerState.seconds <= 10);
                    document.title = `å€’è®¡æ—¶ ${timerState.minutes.toString().padStart(2, '0')}:${timerState.seconds.toString().padStart(2, '0')}`;
                }
            };

            // å¼€å§‹ç‹¬ç«‹è®¡æ—¶
            startTimer = function() {
                if (!timerDom) return;
                
                // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„å£°éŸ³
                if (timerState.endSound) {
                    timerState.endSound.pause();
                    timerState.endSound.currentTime = 0;
                }
                
                if (timerState.isRunning) {
                    clearInterval(timerState.timer);
                    timerState.isRunning = false;
                    timerDom.timerStartBtn.innerHTML = '<i class="fa fa-play fa-lg"></i><span class="text-lg font-medium">ç»§ç»­è®¡æ—¶</span>';
                    timerDom.timerMessage.textContent = 'è®¡æ—¶å·²æš‚åœï¼Œç‚¹å‡»ç»§ç»­';
                    return;
                }

                // å¯åŠ¨å‰åŒæ­¥è¾“å…¥æ¡†çš„å€¼åˆ°timerState
            timerState.minutes = parseInt(timerDom.timerMinutes.value) || 0;
            timerState.seconds = parseInt(timerDom.timerSeconds.value) || 0;
            updateTimerDisplay();
            
            timerState.isRunning = true;
            timerDom.timerStartBtn.innerHTML = '<i class="fa fa-pause fa-lg"></i><span class="text-lg font-medium">æš‚åœè®¡æ—¶</span>';
            timerDom.timerMessage.textContent = 'è®¡æ—¶è¿›è¡Œä¸­...';
            timerDom.timerMinutes.disabled = true;
            timerDom.timerSeconds.disabled = true;
            timerDom.timerInput.disabled = true;

            initTimerAudio();

                appState.clickSound.currentTime = 0;
                appState.clickSound.play();
                timerDom.timerStartBtn.classList.add('btn-bounce');
                setTimeout(() => {
                    timerDom.timerStartBtn.classList.remove('btn-bounce');
                }, 300);

                timerState.timer = setInterval(() => {
                    if (timerState.minutes === 0 && timerState.seconds <= 0) {
                        clearInterval(timerState.timer);
                        timerState.isRunning = false;
                        timerDom.timerStartBtn.innerHTML = '<i class="fa fa-play fa-lg"></i><span class="text-lg font-medium">é‡æ–°å¼€å§‹</span>';
                        timerDom.timerMessage.textContent = 'å€’è®¡æ—¶ç»“æŸï¼';
                        timerDom.timerMinutes.disabled = false;
                        timerDom.timerSeconds.disabled = false;
                        timerDom.timerInput.disabled = false;

                        initTimerAudio();
                        if (timerState.endSound) {
                            timerState.endSound.currentTime = 0;
                            timerState.endSound.play().catch(error => {
                                console.error('æ’­æ”¾å¤±è´¥:', error);
                                timerDom.timerMessage.textContent = 'å€’è®¡æ—¶ç»“æŸï¼(å£°éŸ³æ’­æ”¾å¤±è´¥)';
                            });
                        } else {
                            timerDom.timerMessage.textContent = 'å€’è®¡æ—¶ç»“æŸï¼(æ— æ³•æ’­æ”¾å£°éŸ³)';
                        }
                        return;
                    }
                    if (timerState.seconds <= 0) {
                        if (timerState.minutes > 0) {
                            timerState.minutes--;
                            timerState.seconds = 59;
                        }
                    } else {
                        timerState.seconds--;
                    }
                    updateTimerDisplay();
                }, 1000);
            };

            // é‡ç½®ç‹¬ç«‹è®¡æ—¶å™¨
            resetTimer = function() {
                if (!timerDom) return;
                
                clearInterval(timerState.timer);
                timerState.isRunning = false;
                timerState.minutes = 0;
                timerState.seconds = 0;
                timerDom.timerMinutes.value = 0;
                timerDom.timerSeconds.value = 0;
                timerDom.timerInput.value = 0;
                updateTimerDisplay();
                timerDom.timerStartBtn.innerHTML = '<i class="fa fa-play fa-lg"></i><span class="text-lg font-medium">å¼€å§‹è®¡æ—¶</span>';
                timerDom.timerStartBtn.disabled = false;
                timerDom.timerMinutes.disabled = false;
                timerDom.timerSeconds.disabled = false;
                timerDom.timerInput.disabled = false;
                

                if (timerState.endSound) {
                    timerState.endSound.pause();
                    timerState.endSound.currentTime = 0;
                }

                appState.clickSound.currentTime = 0;
                appState.clickSound.play();
                timerDom.timerResetBtn.classList.add('btn-bounce');
                setTimeout(() => {
                    timerDom.timerResetBtn.classList.remove('btn-bounce');
                }, 300);
            };

            // åˆ‡æ¢æ¨¡å¼ - ä¿®å¤æ¨¡å¼åˆ‡æ¢å¼‚å¸¸é—®é¢˜
            switchMode = function(mode) {
                if (!timerDom) return;
                
                // éšè—æ‰€æœ‰æ¨¡å¼
                timerDom.workoutMode.classList.add('hidden');
                timerDom.timerMode.classList.add('hidden');
                timerDom.planMode.classList.add('hidden');
                
                // ç§»é™¤æ‰€æœ‰æ¨¡å¼çš„åŠ¨ç”»ç±»
                timerDom.workoutMode.classList.remove('mode-enter', 'mode-enter-active', 'mode-exit-active');
                timerDom.timerMode.classList.remove('mode-enter', 'mode-enter-active', 'mode-exit-active');
                timerDom.planMode.classList.remove('mode-enter', 'mode-enter-active', 'mode-exit-active');
                
                // æ˜¾ç¤ºç›®æ ‡æ¨¡å¼
                let targetMode;
                if (mode === 'workout') {
                    targetMode = timerDom.workoutMode;
                } else if (mode === 'timer') {
                    targetMode = timerDom.timerMode;
                } else if (mode === 'plan') {
                    targetMode = timerDom.planMode;
                }
                
                // å‡†å¤‡ç›®æ ‡æ¨¡å¼çš„è¿›å…¥åŠ¨ç”»
                targetMode.classList.remove('hidden');
                targetMode.classList.add('mode-enter');
                
                // è§¦å‘é‡æ’åæ·»åŠ è¿›å…¥åŠ¨ç”»ç±»
                setTimeout(() => {
                    targetMode.classList.remove('mode-enter');
                    targetMode.classList.add('mode-enter-active');
                }, 10);
                
                // æ›´æ–°æ ‡ç­¾æ ·å¼
                if (mode === 'workout') {
                    timerDom.workoutTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                    timerDom.workoutTab.classList.remove('text-slate-500');
                    timerDom.timerTab.classList.add('text-slate-500');
                    timerDom.timerTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    timerDom.planTab.classList.add('text-slate-500');
                    timerDom.planTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    document.title = 'æ™ºèƒ½å¥èº«å€’è®¡æ—¶';
                } else if (mode === 'timer') {
                    timerDom.workoutTab.classList.add('text-slate-500');
                    timerDom.workoutTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    timerDom.timerTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                    timerDom.timerTab.classList.remove('text-slate-500');
                    timerDom.planTab.classList.add('text-slate-500');
                    timerDom.planTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    updateTimerDisplay();
                } else if (mode === 'plan') {
                    // ç¡®ä¿è®¡æ—¶å™¨å·²æš‚åœ
                    if (timerState.isRunning) {
                        clearInterval(timerState.timer);
                        timerState.isRunning = false;
                        if (timerDom) {
                            timerDom.timerStartBtn.innerHTML = '<i class="fa fa-play fa-lg"></i><span class="text-lg font-medium">å¼€å§‹è®¡æ—¶</span>';
                            timerDom.timerMessage.textContent = '';
                            timerDom.timerMinutes.disabled = false;
                            timerDom.timerSeconds.disabled = false;
                            timerDom.timerInput.disabled = false;
                        }
                    }
                    
                    timerDom.workoutTab.classList.add('text-slate-500');
                    timerDom.workoutTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    timerDom.timerTab.classList.add('text-slate-500');
                    timerDom.timerTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    timerDom.planTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                    timerDom.planTab.classList.remove('text-slate-500');
                    document.title = 'æ¯æ—¥è®­ç»ƒè®¡åˆ’';
                }

                
                appState.clickSound.currentTime = 0;
                appState.clickSound.play();
            };

            // äº‹ä»¶ç›‘å¬
            timerDom.workoutTab.addEventListener('click', () => switchMode('workout'));
            timerDom.timerTab.addEventListener('click', () => switchMode('timer'));
            timerDom.planTab.addEventListener('click', () => switchMode('plan'));
            timerDom.timerStartBtn.addEventListener('click', startTimer);
            timerDom.timerResetBtn.addEventListener('click', resetTimer);
            
            timerDom.timerMinutes.addEventListener('change', () => {
                if (!timerState.isRunning) {
                    let minutes = parseInt(timerDom.timerMinutes.value) || 0;
                    minutes = Math.max(0, minutes);
                    timerDom.timerMinutes.value = minutes;
                    timerState.minutes = minutes;
                    timerDom.timerInput.value = minutes * 60 + timerState.seconds;
                    updateTimerDisplay();
                }
            });
            
            timerDom.timerSeconds.addEventListener('change', () => {
                if (!timerState.isRunning) {
                    let seconds = parseInt(timerDom.timerSeconds.value) || 0;
                    seconds = Math.max(0, Math.min(59, seconds));
                    timerDom.timerSeconds.value = seconds;
                    timerState.seconds = seconds;
                    timerDom.timerInput.value = timerState.minutes * 60 + seconds;
                    updateTimerDisplay();
                }
            });

            // å¤„ç†ç§’è¾“å…¥å¹¶è½¬æ¢ä¸ºåˆ†é’Ÿå’Œç§’
            function handleTimerInput() {
                if (!timerState.isRunning && timerDom) {
                    let totalSeconds = parseInt(timerDom.timerInput.value) || 0;
                    totalSeconds = Math.max(0, totalSeconds);
                    
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    
                    timerState.minutes = minutes;
                    timerState.seconds = seconds;
                    
                    timerDom.timerMinutes.value = minutes;
                    timerDom.timerSeconds.value = seconds;
                    
                    updateTimerDisplay();
                }
            }
            
            timerDom.timerInput.addEventListener('change', handleTimerInput);
            timerDom.timerInput.addEventListener('input', handleTimerInput);

            // åˆå§‹åŒ–ç‹¬ç«‹è®¡æ—¶å™¨æ˜¾ç¤º
            updateTimerDisplay();
            // æ¸²æŸ“è®­ç»ƒè®¡åˆ’
            renderTrainingPlans();
            // åˆå§‹åŒ–é”»ç‚¼æ¨¡å¼å¤´éƒ¨æ˜¾ç¤º
            updateWorkoutModeHeader();
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!timerDom || timerDom.workoutMode.classList.contains('block')) {
                    dom.startBtn.click();
                }
            }
            if (e.key.toLowerCase() === 'r') {
                e.preventDefault();
                if (timerDom && timerDom.timerMode.classList.contains('block')) {
                    resetTimer();
                } else {
                    dom.resetBtn.click();
                }
            }
        });
    </script>
</body>
</html>
